# Traffic Sentinel - An IoT Traffic Monitoring System

![Traffic Sentinel Logo](traffic_sentinel_logo.png)

Traffic Sentinel is a scalable IoT-based traffic monitoring system designed to process streaming data from IP cameras, apply intelligent vehicle detection using YOLO (You Only Look Once), and provide real-time insights into traffic patterns on roads. The system leverages Fog nodes for intermediate processing, Apache Flink for data processing, Redis for caching and session management, and MQTT for communication between nodes.

## Table of Contents

- [Introduction](#introduction)
- [Architecture Overview](#architecture-overview)
- [Technologies Used](#technologies-used)
- [Components](#components)
- [Getting Started](#getting-started)
- [Usage](#usage)
- [Contributing](#contributing)
- [License](#license)

## Introduction

Traffic congestion and road safety are critical concerns in modern urban environments. Traffic Sentinel addresses these challenges by providing a comprehensive IoT-based traffic monitoring solution. The system collects video streams from IP cameras deployed on roads and uses machine learning techniques to detect and track vehicles in real time. This data is then processed and analyzed to provide insights into traffic flow, congestion, and potential safety issues.


## Services Foundation Layer
The Services Foundation Layer forms the bedrock of our system architecture, providing the essential infrastructure and core functionalities that support the entire ecosystem. This layer encompasses foundational components such as Kafka, Mosquitto, MongoDB, Vault, Redis, and other essential building blocks. It establishes the fundamental communication, data storage, security, and orchestration mechanisms that serve as the backbone for the entire solution. Services at this level handle critical tasks such as message queuing, data persistence, authentication, authorization, and secret management. The Services Foundation Layer ensures reliability, security, and scalability across the entire platform, serving as the base upon which subsequent layers are built.

## Framework-Extended Services Layer
The Framework-Extended Services Layer builds upon the strong foundation provided by the Services Foundation Layer. This layer extends the core capabilities by introducing specialized frameworks and advanced services that address specific application requirements. Apache Flink, a powerful real-time data processing framework, is a prime example of a component within this layer. Other services that enable complex stream processing, analytics, and data transformations also reside here. The Framework-Extended Services Layer adds a layer of sophistication to the system, offering advanced tools for analyzing, processing, and deriving insights from data streams. These services enrich the capabilities of the foundational layer, catering to intricate business needs and data processing scenarios.

## Fog Stream Processing Nodes Layer
The Fog Stream Processing Nodes Layer encapsulates the nodes within our edge computing architecture that specialize in real-time stream processing of data generated by IP cameras. These nodes are strategically positioned at the network's edge, close to the data sources, to minimize latency and optimize data processing efficiency. In this layer, the streaming data from IP cameras is ingested, analyzed, and transformed in real time to extract valuable insights. These nodes play a pivotal role in ensuring rapid and efficient data processing, enabling immediate responses to changing conditions or events captured by the cameras. By processing the streams at the edge, the Fog Stream Processing Nodes Layer enhances the overall system's performance, responsiveness, and ability to make data-driven decisions in time-critical scenarios.

## Architecture Overview

Traffic Sentinel's architecture is designed to handle the complexities of real-time traffic data processing. It consists of the following key components:

- **Fog Nodes**: Intermediate processing nodes placed strategically to preprocess data from IP cameras, reducing the load on central servers.
- **Apache Flink**: A stream processing framework used for real-time data analysis, enabling tasks like vehicle detection using YOLO.
- **Redis**: A caching and session management tool used for storing temporary data, such as authentication sessions.
- **MQTT**: A lightweight messaging protocol used for communication between Fog nodes and central servers.

## Technologies Used

- **Python**: The main programming language used for developing various components of the system.
- **Flask**: A lightweight web framework used for building the provisioning service that provides camera information to Fog nodes.
- **MongoDB**: A NoSQL database used for storing camera information associated with MAC addresses of Fog nodes.
- **Redis**: An in-memory data store used for caching and session management.
- **Apache Flink**: A stream processing framework for real-time data analysis.
- **YOLO (You Only Look Once)**: A deep learning-based object detection model used for vehicle detection in video streams.
- **MQTT**: A lightweight messaging protocol for communication between Fog nodes and central servers.

## Components

The Traffic Sentinel system comprises the following components:

- **Fog Node**: Responsible for intermediate data processing and communication with IP cameras, Apache Flink, and central servers.
- **Provisioning Service**: A Flask-based web service that provides camera information to Fog nodes based on MAC addresses.
- **Apache Flink Jobs**: Real-time data processing tasks for vehicle detection using the YOLO model.
- **Redis Cache**: Used for caching authentication sessions and other temporary data.
- **MongoDB Database**: Stores camera information associated with MAC addresses.

## Getting Started

1. **Installation**: Clone the repository and install the required dependencies using the provided `requirements.txt` file.

2. **Configuration**: Configure the system by providing the necessary environment variables, such as MQTT broker, Redis host, MongoDB connection string, etc.

3. **Run the Components**: Start the Fog nodes, Apache Flink jobs, and the Flask-based Provisioning Service.

## Usage

1. **Authentication and Provisioning**: When a Fog node starts, it initiates the authentication process with the central server using CHAP. Upon successful authentication, it requests camera information from the Provisioning Service.

2. **Real-time Data Processing**: The Fog nodes capture video streams from IP cameras and preprocess the data. The processed data is then sent to Apache Flink for real-time analysis using YOLO for vehicle detection.

3. **Data Insights**: The analyzed data is used to generate insights into traffic patterns, congestion, and vehicle movement. These insights can be visualized through a dashboard or accessed through APIs.

## CHAP Authentication API Documentation

This API provides Challenge-Handshake Authentication Protocol (CHAP) authentication for Fog nodes. It generates and verifies challenges for authentication.

### Endpoints

#### 1. Get Challenge

- **HTTP Method:** `POST`
- **URL:** `/get_challenge`
- **Description:** Generate and store a CHAP challenge for authentication.
- **Request Body:**
  - `mac_address` (JSON, required): The MAC address of the device.
- **Response:**
  - `challenge` (JSON): The generated challenge.
- **HTTP Status Codes:**
  - `200 OK`: Challenge generated successfully.
  - `404 Not Found`: Challenge not found (may happen if the challenge expired before authentication).
  - `500 Internal Server Error`: Server error.

#### 2. Authenticate

- **HTTP Method:** `POST`
- **URL:** `/authenticate`
- **Description:** Authenticate the client's response to the CHAP challenge.
- **Request Body:**
  - `mac_address` (JSON, required): The MAC address of the device.
  - `client_response` (JSON, required): The client's response to the challenge.
- **Response:**
  - `message` (JSON): A message indicating the authentication result.
  - `session_id` (JSON): A session ID for authenticated sessions.
- **HTTP Status Codes:**
  - `200 OK`: Authentication successful. A session ID is provided.
  - `401 Unauthorized`: Authentication failed.
  - `404 Not Found`: Challenge not found.
  - `500 Internal Server Error`: Server error.

### Errors

In case of any errors or issues, the API will respond with appropriate HTTP status codes and JSON messages describing the error.

### Internal Functions

#### 1. `_get_vault_token()`

- **Description:** Retrieve the Vault token from Redis.
- **Response:** Vault token (str).
- **Errors:** Throws an exception if the token is not found or if there is an error retrieving it.

#### 2. `_get_stored_password(mac_address, vault_token)`

- **Description:** Retrieve the stored password for a MAC address from Vault.
- **Parameters:**
  - `mac_address` (str): The MAC address of the device.
  - `vault_token` (str): The Vault token for authentication.
- **Response:** Stored password (str).
- **Errors:** Throws an exception if the password is not found or if there is an error retrieving it.

#### 3. `_get_code_hash(mac_address, vault_token)`

- **Description:** Retrieve the code hash for a MAC address from Vault.
- **Parameters:**
  - `mac_address` (str): The MAC address of the device.
  - `vault_token` (str): The Vault token for authentication.
- **Response:** Code hash (str).
- **Errors:** Throws an exception if the code hash is not found or if there is an error retrieving it.

## Provisioning API Documentation

This API is designed to manage and provision camera devices with their associated information. It allows you to retrieve camera details, link new cameras, remove camera associations, and list all existing camera associations.

### Introduction

The Provisioning API is used for managing camera devices and their related data. It communicates with a MongoDB database to store and retrieve camera information. Additionally, it utilizes Redis for session management and authentication.

### Endpoints

#### 1. Get Fog Password

- **HTTP Method:** `GET`
- **URL:** `/get-fog-password`
- **Description:** Retrieve the Fog node's password associated with a MAC address.
- **Parameters:**
  - `mac_address` (query parameter, required): MAC address of the device for which you want to retrieve the password.
- **Response:**
  - `fog_password` (JSON): The Fog node's password.
- **HTTP Status Codes:**
  - `200 OK`: Successful retrieval.
  - `400 Bad Request`: MAC address not provided.
  - `404 Not Found`: Node password not found.

#### 2. Provision Camera

- **HTTP Method:** `GET`
- **URL:** `/provision`
- **Description:** Retrieve camera details based on a MAC address and an authentication session.
- **Parameters:**
  - `mac_address` (query parameter, required): MAC address of the camera device.
- **Headers:**
  - `X-Session-ID` (required): Authentication session ID.
- **Response:**
  - `camera_url` (JSON): The camera's URL.
  - `camera_username` (JSON): The camera's username.
  - `camera_password` (JSON): The camera's password.
- **HTTP Status Codes:**
  - `200 OK`: Successful retrieval.
  - `400 Bad Request`: MAC address or session ID not provided.
  - `401 Unauthorized`: Invalid session ID.
  - `404 Not Found`: MAC address not found.

#### 3. Provision Camera (Link)

- **HTTP Method:** `POST`
- **URL:** `/provision/link`
- **Description:** Link a new camera with its details.
- **Request Body:**
  - `mac_address` (required): MAC address of the new camera.
  - `camera_url` (required): URL of the camera.
  - `camera_username` (required): Username for accessing the camera.
  - `camera_password` (required): Password for accessing the camera.
- **Response:**
  - `message` (JSON): A message indicating the result of the operation.
- **HTTP Status Codes:**
  - `201 Created`: Camera provisioned successfully.
  - `400 Bad Request`: Missing required data.
  - `409 Conflict`: MAC address already exists.

#### 4. Remove Camera Association

- **HTTP Method:** `DELETE`
- **URL:** `/provision/remove`
- **Description:** Remove the association of a camera with a MAC address.
- **Parameters:**
  - `mac_address` (query parameter, required): MAC address of the camera to disassociate.
- **Response:**
  - `message` (JSON): A message indicating the result of the operation.
- **HTTP Status Codes:**
  - `200 OK`: Camera association removed.
  - `400 Bad Request`: MAC address not provided.
  - `404 Not Found`: MAC address not found.

#### 5. List Camera Associations

- **HTTP Method:** `GET`
- **URL:** `/provision/list`
- **Description:** Retrieve a list of all MAC addresses with their associated camera details.
- **Response:**
  - `mac_address` (JSON): The MAC address of a camera.
  - `camera_url` (JSON): The camera's URL.
  - `camera_username` (JSON): The camera's username.
  - `camera_password` (JSON): The camera's password.
- **HTTP Status Codes:**
  - `200 OK`: Successful retrieval.

### Errors

In case of any errors or issues, the API will respond with appropriate HTTP status codes and JSON messages describing the error.

## Contributing

Contributions are welcome! If you'd like to contribute to Traffic Sentinel, please follow the guidelines in [CONTRIBUTING.md](CONTRIBUTING.md).

## License

This project is licensed under the [MIT License](LICENSE).

---

## Credits

Traffic Sentinel is developed and maintained by Sergio Sánchez Sánchez. Special thanks to the open-source community and the contributors who have made this project possible.

---

