version: "3"

services:

  # Flask-based authentication service for authorization and authentication
  auth_service:
    image: ssanchez11/smart_highway_net_auth_service:0.0.1
    container_name: auth-service
    env_file:
      - ./.env
    environment:
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - VAULT_ADDRESS=${VAULT_ADDRESS}
    ports:
      - "5000:5000"  # Map container port 5000 to host port 5000
    networks:
      - smart-highway-net

  # Notifier service for sending notifications
  notifier:
    image: ssanchez11/smart_highway_net_notifier_service:0.0.1
    container_name: notifier-service
    env_file:
      - ./.env
    environment:
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_EXPIRATION_CHANNEL=${REDIS_EXPIRATION_CHANNEL}
      - MQTT_BROKER=${MQTT_BROKER}
      - MQTT_PORT=${MQTT_PORT}
      - MQTT_REAUTH_TOPIC=${MQTT_REAUTH_TOPIC}
    networks:
      - smart-highway-net

  # Provision service for setting up configurations
  provision:
    image: ssanchez11/smart_highway_net_provision_service:0.0.1
    container_name: provision-service
    env_file:
      - ./.env
    environment:
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - MONGO_HOST=${MONGO_HOST}
      - MONGO_PORT=${MONGO_PORT}
    ports:
      - "5001:5001"  # Map container port 5001 to host port 5001
    networks:
      - smart-highway-net

  # Integrator service for data integration
  integrator:
    image: ssanchez11/smart_highway_net_integrator_service:0.0.1
    container_name: integrator-service
    env_file:
      - ./.env
    environment:
      - MQTT_BROKER_USERNAME=${MQTT_BROKER_USERNAME}
      - MQTT_BROKER_PASSWORD=${MQTT_BROKER_PASSWORD}
      - MQTT_BROKER=${MQTT_BROKER}
      - MQTT_TOPIC=${MQTT_TOPIC}
      - KAFKA_BROKER=${KAFKA_BROKER}
      - KAFKA_TOPIC=${KAFKA_TOPIC}
    networks:
      - smart-highway-net

  # Flink Job Manager service for distributed processing
  jobmanager:
    image: ssanchez11/smart_highway_net_job_manager_flink:0.0.1
    container_name: job-manager-flink
    volumes:
    - ./flink/jobmanager/data:/home/pyflink  # Mount local data volume to the container
    - ./flink/jobs:/opt/flink/jobs  # Map local jobs directory to the container
    ports:
      - "8085:8081"  # Map container port 8081 to host port 8085
    command: jobmanager  # Run the job manager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager  # Set Flink's job manager address
    networks:
      - smart-highway-net

  # Flink Task Manager service for distributed processing
  taskmanager:
    image: ssanchez11/smart_highway_net_task_manager_flink:0.0.1
    container_name: task-manager-flink
    depends_on:
      - jobmanager  # Ensure that the job manager is ready before starting the task manager
    command: taskmanager  # Run the task manager
    scale: 1  # Scale to 1 instance
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
        taskmanager.numberOfTaskSlots: 2
    networks:
      - smart-highway-net

# Define a custom bridge network for the services to communicate
networks:
  smart-highway-net:
    driver: bridge  # Use the bridge network driver
